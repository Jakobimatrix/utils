name: ubuntu C/C++ CI

permissions:
  contents: read
  checks: write

on:
  push:
    branches: [ main, dev, master, release ]
  pull_request:
    branches: [ main, dev, master, release ]

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Create workspace tar (exclude .git and IDE stuff)
        run: |
          set -e
          touch workspace.tar
          touch workspace.tar.gz
          tar --exclude='workspace.tar.gz' --exclude='workspace.tar' --exclude-vcs --exclude='**/.idea' --exclude='**/.vscode' --exclude='**/*.log' -cf workspace.tar .
          tar --append -f workspace.tar .git
          gzip -f workspace.tar

      - uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: workspace.tar.gz
          retention-days: 1
          
      - name: Make sure scripts exist
        run: |
          set -e
          source initRepo/.environment || exit 1
          source initRepo/scripts/ensureToolVersion.sh || exit 1


  shellcheck:
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      failed: ${{ steps.shell_result.outputs.failed }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          sudo apt-get update
          sudo apt-get install -y shellcheck
          ./initRepo/scripts/checkShellCheck.sh

  doxygenHeader:
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      failed: ${{ steps.shell_result.outputs.failed }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          ./initRepo/scripts/checkFileHeaders.sh
          
  clang_format:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .
          
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('initRepo/.environment') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          source initRepo/.environment
          if [ -f .environment ]; then source .environment; fi
          sudo apt-get update
          sudo apt-get install -y clang-format-${CLANG_FORMAT_VERSION}
          source initRepo/scripts/ensureToolVersion.sh
          ensure_tool_versioned clang-format "${CLANG_FORMAT_VERSION}"
          ./initRepo/scripts/checkClangFormat.sh

  doxygen-docs:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          sudo apt-get update
          sudo apt-get install -y cmake make
          sudo apt-get install -y doxygen graphviz
          sudo apt-get install -y texlive-latex-base texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended

          # Run Doxygen (expects a Doxyfile in repo root or adjust path)
          ./initRepo/scripts/createDokumentation.sh

          tar -czf docu_${{ github.event.repository.name }}.tar.gz -C doxygen .

      - name: Upload Doxygen documentation
        uses: actions/upload-artifact@v4
        with:
          name: docu_${{ github.event.repository.name }}
          path: docu_${{ github.event.repository.name }}.tar.gz
          retention-days: 1 

      - name: Doxygen in summary
        run: |
          echo "## Doxygen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can download the Doxygen documentation from the workflow artifacts." >> $GITHUB_STEP_SUMMARY


  build:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [debug, release]
        arch: [x86, x64]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .
      
      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          source initRepo/.environment
          if [ -f .environment ]; then source .environment; fi
   
          if [ "${{ matrix.arch }}" = "x86" ]; then
            sudo dpkg --add-architecture i386
            sudo apt-get update
            sudo apt-get install -y libc6:i386 libstdc++6:i386 libc6-dev:i386
            sudo apt-get install -y libstdc++-${GCC_VERSION}-dev:i386 g++-${GCC_VERSION}-multilib gcc-${GCC_VERSION}-multilib
          fi
   
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc-${GCC_VERSION} g++-${GCC_VERSION}
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${GCC_VERSION} 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-${GCC_VERSION} 100
            source initRepo/scripts/ensureToolVersion.sh
            ensure_tool_versioned g++ "${GCC_VERSION}"
            ensure_tool_versioned gcc "${GCC_VERSION}"
          else
            sudo apt-get install -y clang-${CLANG_VERSION} lld
            if ! command -v ld.lld &>/dev/null; then
                sudo ln -s /usr/bin/ld.lld-${CLANG_VERSION} /usr/bin/ld.lld || true
            fi
            sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${CLANG_VERSION} 100
            sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${CLANG_VERSION} 100
            source initRepo/scripts/ensureToolVersion.sh
            ensure_tool_versioned clang++ "${CLANG_VERSION}"
            ensure_tool_versioned clang "${CLANG_VERSION}"
          fi
          sudo apt-get install -y cmake make
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            if [ "${{ matrix.build_type }}" = "debug" ]; then
                ./initRepo/scripts/build.sh -d -t -g --compiler gcc --arch ${{ matrix.arch }}
            else
                ./initRepo/scripts/build.sh -r -t --compiler gcc --arch ${{ matrix.arch }}
            fi
            tar -czf gcc_${{ matrix.arch }}_${{ matrix.build_type }}_build.tar.gz build-gcc-${GCC_VERSION}-${{ matrix.build_type }}-${ARCH}-${{ matrix.arch }}
          else [ "${{ matrix.compiler }}" = "clang" ]
            ./initRepo/scripts/build.sh --${{ matrix.build_type }} -f --compiler clang --arch ${{ matrix.arch }}
            ./initRepo/scripts/build.sh --${{ matrix.build_type }} -t --compiler clang --arch ${{ matrix.arch }}
            tar -czf clang_${{ matrix.arch }}_${{ matrix.build_type }}_build.tar.gz build-clang-${CLANG_VERSION}-${{ matrix.build_type }}-${ARCH}-${{ matrix.arch }}
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.compiler }}-${{ matrix.arch }}-${{ matrix.build_type }}-build
          path: ${{ matrix.compiler }}_${{ matrix.arch }}_${{ matrix.build_type }}_build.tar.gz
          retention-days: 1


  gcc_unit_tests_and_coverage:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    strategy:
      matrix:
        build_type: [debug, release]
        arch: [x86, x64]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - uses: actions/download-artifact@v4
        with:
          name: gcc-${{ matrix.arch }}-${{ matrix.build_type }}-build
          path: .

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          tar -xzf gcc_${{ matrix.arch }}_${{ matrix.build_type }}_build.tar.gz -C .
          source initRepo/.environment
          if [ -f .environment ]; then source .environment; fi
          echo "GCC_VERSION=$GCC_VERSION" >> $GITHUB_ENV
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          if [ "${{ matrix.arch }}" = "x86" ]; then
            sudo dpkg --add-architecture i386
            sudo apt-get update
            sudo apt-get install -y libc6:i386 libstdc++6:i386 libc6-dev:i386
            sudo apt-get install -y libstdc++-${GCC_VERSION}-dev:i386 g++-${GCC_VERSION}-multilib gcc-${GCC_VERSION}-multilib 
          fi
          sudo apt-get update
          if [ "${{ matrix.build_type }}" = "debug" ] && [ "${{ matrix.arch }}" = "x64" ]; then
            sudo apt-get install -y gcovr lcov
          fi
          sudo apt-get install -y cmake make
          ./initRepo/scripts/build.sh -s -T --${{ matrix.build_type }} -J --compiler gcc --arch ${{ matrix.arch }}  # skip cmake and build + run Tests in Junit format output

      - name: Publish GCC test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            build-gcc-${{ env.GCC_VERSION }}-${{ matrix.build_type }}-${{ env.ARCH }}-${{ matrix.arch }}/test_results.xml
            
      - name: Generate coverage report
        if: matrix.build_type == 'debug' && matrix.arch == 'x64'
        run: |
          gcovr --gcov-executable gcov-${{ env.GCC_VERSION }} \
              -r . build-gcc-${{ env.GCC_VERSION }}-debug-${{ env.ARCH }}-x64/src \
              --exclude '.*_deps/.*' --gcov-ignore-parse-errors \
              --xml-pretty -o coverage.xml

      - name: Publish coverage summary
        if: matrix.build_type == 'debug' && matrix.arch == 'x64'
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          badge: true
          format: markdown
          output: file
          
      - name: Append coverage to summary # workaround: publish-unit-test-result-action overwrites the summary
        if: matrix.build_type == 'debug' && matrix.arch == 'x64'
        run: |
          echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
          cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY
          
          
  clang_unit_tests:
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      matrix:
        build_type: [debug, release]
        arch: [x86, x64]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - uses: actions/download-artifact@v4
        with:
          name: clang-${{ matrix.arch }}-${{ matrix.build_type }}-build
          path: .

      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          tar -xzf clang_${{ matrix.arch }}_${{ matrix.build_type }}_build.tar.gz -C .
          source initRepo/.environment
          if [ -f .environment ]; then source .environment; fi
          echo "CLANG_VERSION=$CLANG_VERSION" >> $GITHUB_ENV
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          if [ "${{ matrix.arch }}" = "x86" ]; then
            sudo dpkg --add-architecture i386
            sudo apt-get update
            sudo apt-get install -y libc6:i386 libstdc++6:i386 libc6-dev:i386
          fi
          sudo apt-get update
          sudo apt-get install -y cmake make
          ./initRepo/scripts/build.sh -s -T --${{ matrix.build_type }} -J --compiler clang --arch ${{ matrix.arch }}

      - name: Publish Clang test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            build-clang-${{ env.CLANG_VERSION }}-${{ matrix.build_type }}-${{ env.ARCH }}-${{ matrix.arch }}/test_results.xml


  clang_tidy:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - uses: actions/download-artifact@v4
        with:
          name: clang-x64-debug-build
          path: .  
          
      - run: |
          set -e
          tar -xzf workspace.tar.gz -C .
          tar -xzf clang_x64_debug_build.tar.gz -C .
          source initRepo/.environment
          if [ -f .environment ]; then source .environment; fi
          sudo apt-get update
          sudo apt-get install -y clang-tidy-${CLANG_TIDY_VERSION}
          sudo apt-get install -y cmake make
          source initRepo/scripts/ensureToolVersion.sh
          ensure_tool_versioned clang-tidy "${CLANG_TIDY_VERSION}"

      - name: tidy_result
        run: |
          set -e
          ./initRepo/scripts/checkClangTidy.sh
          
